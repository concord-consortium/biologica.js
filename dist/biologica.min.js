(function(){var a={}.hasOwnProperty,b=[].indexOf||function(e){for(var d=0,c=this.length;d<c;d++){if(d in this&&this[d]===e){return d}}return -1};Array.prototype.remove=function(e,d){var c;c=this.slice((d||e)+1||this.length);this.length=e<0?this.length+e:e;return this.push.apply(this,c)};Array.prototype.removeObj=function(d){var c;c=this.indexOf(d);if(~c){this.remove(c);return true}else{return false}};Array.prototype.replaceFirst=function(d,c){return this[this.indexOf(d)]=c};Array.prototype.shuffle=function(){var e,c,d;d=this.length;if(d){while(--d){e=Math.floor(Math.random()*(d+1));c=this[e];this[e]=this[d];this[d]=c}}return this};window.ExtMath={};ExtMath.randomInt=function(c){return Math.floor(Math.random()*c)};ExtMath.flip=function(){return ExtMath.randomInt(2)};window.BioLogica={};BioLogica.FEMALE=1;BioLogica.MALE=0;BioLogica.Chromosome=(function(){function c(g,e,f,d){var h=this;this.species=g;this.chromosome=e;this.side=f;this.alleles=d.sort(function(j,i){if(h.getAllelesPosition(j)>h.getAllelesPosition(i)){return 1}else{return -1}})}c.prototype.clone=function(d){return new BioLogica.Chromosome(this.species,this.chromosome,d||this.side,this.alleles.slice(0))};c.prototype.lengthInCentimorgans=100;c.prototype.getlengthInBasePairs=function(){return this.species.chromosomesLength[this.chromosome]};c.prototype.getGeneOfAllele=function(d){var g,f,e;e=this.species.geneList;for(f in e){if(!a.call(e,f)){continue}g=e[f];if(~g.alleles.indexOf(d)){return f}}};c.prototype.getAllelesPosition=function(d){var f,e;f=this.getGeneOfAllele(d);return((e=this.species.geneList[f])!=null?e.start:void 0)||-1};return c})();BioLogica.Chromosome.createChromosome=function(l,k,g){var c,h,f,d,j,e;f=[];e=l.alleles;for(h=d=0,j=e.length;d<j;h=++d){c=e[h];if(l.getAllelesPosition(c)<g){f.push(c)}else{f.push(k.alleles[h])}}return new BioLogica.Chromosome(l.species,l.chromosome,l.side,f)};BioLogica.Genotype=(function(){function c(l,d,j){var h,e,k,f,i,g;this.sex=j;this.chromosomes={};this.allAlleles=[];for(e in d){if(!a.call(d,e)){continue}f=d[e];this.chromosomes[e]={};for(k in f){if(!a.call(f,k)){continue}h=f[k];if(k==="y"){h=[]}this.chromosomes[e][k]=new BioLogica.Chromosome(l,e,k,h.slice(0));this.allAlleles=this.allAlleles.concat(h.slice(0))}}if((i=this.sex)==null){this.sex=((g=this.chromosomes.XY)!=null?g.y:void 0)!=null?BioLogica.MALE:BioLogica.FEMALE}}c.prototype.containsAlleles=function(e){var h,f,g,d;h=this.allAlleles.slice(0);if(this.sex===BioLogica.MALE){h.push("Y")}for(g=0,d=e.length;g<d;g++){f=e[g];if(!h.removeObj(f)){return false}}return true};c.prototype.replaceAllele=function(d,e,f){d.alleles.replaceFirst(e,f);return this.allAlleles.replaceFirst(e,f)};c.prototype.getAlleleString=function(){var f,q,h,n,e,d,l,p,m,j,o,k,g;q="";k=this.chromosomes;for(n in k){if(!a.call(k,n)){continue}d=k[n];for(m in d){if(!a.call(d,m)){continue}e=d[m];h=e.alleles;p=m==="x"?"y":m==="x1"?"x2":"b";if(m==="x"||m==="x1"){m="a"}if(m!=="a"){continue}for(l=j=0,o=h.length;j<o;l=++j){f=h[l];q+=""+m+":"+f+",";if(d[p]){q+="b:"+((g=d[p])!=null?g.alleles[l]:void 0)+","}}}}return q.substring(0,q.length-1)};return c})();BioLogica.Genetics=(function(){function c(f,e,g){var d;this.species=f;this.alleles=e;d=typeof this.alleles==="string"?this.convertAlleleStringToGenotypeHash(this.alleles,g):this.alleles;this.topUpChromosomes(d);this.genotype=new BioLogica.Genotype(this.species,d,g)}c.prototype.convertAlleleStringToGenotypeHash=function(q,l){var g,i,o,d,m,f,n,j,h,p,e,k;n=BioLogica.Genetics.parseAlleleString(q);d={};k=this.species.chromosomeNames;for(j=0,p=k.length;j<p;j++){o=k[j];d[o]={};f=this.getSides(o,l);d[o][f[0]]=[];d[o][f[1]]=[]}for(m in n){if(!a.call(n,m)){continue}i=n[m];if(!i){continue}for(h=0,e=i.length;h<e;h++){g=i[h];o=this.findChromosome(g);if(!o){continue}f=this.getSides(o,l);d[o][m==="a"?f[0]:f[1]].push(g)}}return d};c.prototype.topUpChromosomes=function(d){var h,f,j,i,g,e;e=[];for(h in d){if(!a.call(d,h)){continue}f=d[h];i=this.species.chromosomeGeneMap[h];e.push((function(){var m,k,l;l=[];for(m=0,k=i.length;m<k;m++){j=i[m];l.push((function(){var n;n=[];for(g in f){if(!a.call(f,g)){continue}if(!(this.chromosomeContainsGene(d[h][g],j)||g==="y")){n.push(d[h][g].push(this.getRandomAllele(j)))}else{n.push(void 0)}}return n}).call(this))}return l}).call(this))}return e};c.prototype.getSides=function(d,e){if(d!=="XY"){return["a","b"]}else{if(e===BioLogica.FEMALE){return["x1","x2"]}else{return["x","y"]}}};c.prototype.isAlleleOfGene=function(d,g){var e,h,f;f=this.species.geneList;for(h in f){if(!a.call(f,h)){continue}e=this.species.geneList[h].alleles;if(b.call(e,d)>=0&&b.call(e,g)>=0){return true}}return false};c.prototype.findChromosome=function(g){var e,j,f,i,d,h;h=this.species.chromosomeGeneMap;for(e in h){f=h[e];for(i=0,d=f.length;i<d;i++){j=f[i];if(this.isAlleleOfGene(g,j)){return e}}}return false};c.prototype.chromosomeContainsGene=function(e,h){var f,g,d;for(g=0,d=e.length;g<d;g++){f=e[g];if(this.isAlleleOfGene(f,h)){return true}}return false};c.prototype.getRandomAllele=function(h){var f,i,e,d,g;g=this.species.geneList;for(i in g){if(!a.call(g,i)){continue}d=this.species.geneList[i].alleles;if(b.call(d,h)>=0){f=d;break}}e=Math.floor(Math.random()*f.length);return f[e]};c.prototype.filter=function(d,e){var f=this;return d.filter(function(h){var j,i,g;for(i=0,g=e.length;i<g;i++){j=e[i];if(f.isAlleleOfGene(h,j)){return true}}return false})};c.prototype.performMeiosis=function(r){var p,s,m,e,d,q,k,f,l,n,g,h,o,j;s=[{},{},{},{}];j=this.genotype.chromosomes;for(m in j){if(!a.call(j,m)){continue}d=j[m];g={};n=["b2","b1","a2","a1"];q=false;for(l in d){if(!a.call(d,l)){continue}e=d[l];f=this.getHaploidChromatidSide(e);g[n.pop()]=e.clone(f);g[n.pop()]=e.clone(f);if(l==="y"){q=true}}if(r&&!q){this.crossover(g)}n=["b2","b1","a2","a1"].shuffle();for(k=h=0,o=s.length;h<o;k=++h){p=s[k];p[m]=g[n[k]]}}return s};c.prototype.getHaploidChromatidSide=function(d){if(d.side==="b"){return"a"}else{if(d.side==="x1"||d.side==="x2"){return"x"}else{return d.side}}};c.prototype.crossover=function(d){var h,k,l,j,g,f,i,e;h=this.createCrossoverPoints(d.a1);e=[];for(f=0,i=h.length;f<i;f++){j=h[f];g=["a1","a2"][ExtMath.flip()];k=["b1","b2"][ExtMath.flip()];l=this.crossChromatids(d[g],d[k],j);d[g]=l[0];e.push(d[k]=l[1])}return e};c.prototype.crossChromatids=function(f,e,d){return[BioLogica.Chromosome.createChromosome(e,f,d),BioLogica.Chromosome.createChromosome(f,e,d)]};c.prototype.createCrossoverPoints=function(j){var g,k,h,d,m,e,f,l;e=Math.floor(j.lengthInCentimorgans/10);k=(function(){var n,i;i=[];for(h=n=0;0<=e?n<e:n>e;h=0<=e?++n:--n){if(Math.random()<0.2){i.push(h)}}return i})();while(k.length>3){k.remove(ExtMath.randomInt(k.length))}d=j.getlengthInBasePairs()/e;for(h=f=0,l=k.length;f<l;h=++f){g=k[h];m=ExtMath.randomInt(d);k[h]=(g*d)+m}return k};return c})();BioLogica.Genetics.parseAlleleString=function(d){var e,c;return{a:(e=d.match(/a:([^,])*/g))!=null?e.map(function(g){var f;return(f=g.match(/[^:]+$/))!=null?f[0]:void 0}):void 0,b:(c=d.match(/b:([^,])*/g))!=null?c.map(function(f){var g;return(g=f.match(/[^:]+$/))!=null?g[0]:void 0}):void 0}};BioLogica.Phenotype=(function(){function c(f){var h,e,g,d,k,i,l,j;this.characteristics={};j=f.species.traitRules;for(k in j){if(!a.call(j,k)){continue}d=j[k];for(g in d){if(!a.call(d,g)){continue}e=d[g];for(i=0,l=e.length;i<l;i++){h=e[i];if(f.genotype.containsAlleles(h)){this.characteristics[k]=g;break}}if(this.characteristics[k]){break}}}}return c})();BioLogica.Organism=(function(){function c(e,d,f){var g;this.species=e;this.sex=f;this.alleles=typeof d==="string"?this.preProcessAlleleString(d):d;this.genetics=new BioLogica.Genetics(this.species,this.alleles,this.sex);if((g=this.sex)==null){this.sex=this.genetics.genotype.sex}this.resetPhenotype()}c.prototype.getGenotype=function(){return this.genetics.genotype};c.prototype.resetPhenotype=function(){return this.phenotype=new BioLogica.Phenotype(this.genetics)};c.prototype.getCharacteristic=function(d){return this.phenotype.characteristics[d]};c.prototype.getImageName=function(){return this.species.getImageName(this)};c.prototype.createGametes=function(j,e){var d,f,h,g;if(e==null){e=true}d=[];for(f=h=0,g=Math.floor(j/4);0<=g?h<g:h>g;f=0<=g?++h:--h){d=d.concat(this.genetics.performMeiosis(e))}d=d.concat(this.genetics.performMeiosis(e).slice(0,j%4));if(d.length===1){return d[0]}else{return d}};c.prototype.preProcessAlleleString=function(d){return d.replace(/,+$/,"")};c.prototype.toString=function(){var d,e;e=this.sex===BioLogica.FEMALE?"female":"male";d=this.genetics.genotype.allAlleles;return"Organism: {sex: "+e+", authored alleles: "+this.alleles+", alleles: "+d};return c})();BioLogica.Organism.createOrganism=function(d,c,e){if(c==null){c=""}if(e==null){e=ExtMath.flip()?BioLogica.FEMALE:BioLogica.MALE}return new BioLogica.Organism(d,c,e)};BioLogica.Organism.createLiveOrganism=function(d,c,e){var f;if(c==null){c=""}if(e==null){e=ExtMath.flip()?BioLogica.FEMALE:BioLogica.MALE}f=new BioLogica.Organism(d,c,e);f.species.makeAlive(f);return f};BioLogica.Organism.createFromGametes=function(l,k,e){var h,f,j,d,c,g;for(g in e){d=e[g];if(d.side==="a"){d.side="b"}}if(e.XY.side==="x"){k.XY.side="x1";e.XY.side="x2"}c={};for(j in k){if(!a.call(k,j)){continue}h=k[j];f=e[j];c[j]={};c[j][h.side]=h.alleles;c[j][f.side]=f.alleles}return new BioLogica.Organism(l,c)};BioLogica.breed=function(f,e,g){var d,c;d=f.createGametes(1,g);c=e.createGametes(1,g);return BioLogica.Organism.createFromGametes(f.species,d,c)};BioLogica.Species={};BioLogica.Species.Drake={name:"Drake",chromosomeNames:["1","2","XY"],chromosomeGeneMap:{"1":["t","m","w","h"],"2":["c","b","fl","hl","a"],XY:["d","rh","bog"]},chromosomesLength:{"1":100000000,"2":100000000,XY:70000000},geneList:{tail:{alleles:["T","Tk","t"],start:10000000,length:10584},metalic:{alleles:["M","m"],start:20000000,length:259610},wings:{alleles:["W","w"],start:70000000,length:9094},horns:{alleles:["H","h"],start:85000000,length:19421},color:{alleles:["C","c"],start:15000000,length:64572},black:{alleles:["B","b"],start:25000000,length:17596},forelimbs:{alleles:["Fl","fl"],start:80000000,length:122234},hindlimbs:{alleles:["Hl","hl"],start:85000000,length:6371},armor:{alleles:["A1","A2","a"],start:90000000,length:425156},dilute:{alleles:["D","d","dl"],start:20000000,length:152673},bogbreath:{alleles:["Bog","bog"],start:22000000,length:199642},nose:{alleles:["Rh","rh"],start:60000000,length:2950}},alleleLabelMap:{T:"Long tail",Tk:"Kinked tail",t:"Short tail",M:"Metallic",m:"Nonmetallic",W:"Wings",w:"No wings",H:"No horns",h:"Horns",C:"Colored",c:"Colorless",Fl:"Forelimbs",fl:"No forelimbs",Hl:"Hindlimbs",hl:"No hindlimbs",A1:"'A1' armor",A2:"'A2' armor",a:"'a' armor",B:"Black",b:"Brown",D:"Full color",d:"Dilute color",dl:"dl",Rh:"Nose spike",rh:"No nose spike",Bog:"Normal metabolism",bog:"Bog breath",Y:"Y","":""},traitRules:{armor:{"Five armor":[["A1","A1"],["A1","A2"]],"Three armor":[["A1","a"],["A2","A2"]],"One armor":[["A2","a"]],"No armor":[["a","a"]]},tail:{"Long tail":[["T","T"],["T","Tk"],["T","t"]],"Kinked tail":[["Tk","Tk"],["Tk","t"]],"Short tail":[["t","t"]]},forelimbs:{Forelimbs:[["Fl","Fl"],["Fl","fl"]],"No forelimbs":[["fl","fl"]]},hindlimbs:{Hindlimbs:[["Hl","Hl"],["Hl","hl"]],"No hindlimbs":[["hl","hl"]]},horns:{Hornless:[["H","H"],["H","h"]],Horns:[["h","h"]]},"nose spike":{"Nose spike":[["Rh"]],"No nose spike":[["rh","rh"],["rh","Y"]]},wings:{Wings:[["W","W"],["W","w"]],"No wings":[["w","w"]]},color:{Frost:[["c","c"]],Steel:[["C","M","B","D"]],Copper:[["C","M","b","b","D"]],Silver:[["C","M","B","d","d"],["C","M","B","d","dl"],["C","M","B","dl","dl"],["C","M","B","d","Y"],["C","M","B","dl","Y"]],Gold:[["C","M","b","b","d","d"],["C","M","b","b","d","dl"],["C","M","b","b","dl","dl"],["C","M","b","b","d","Y"],["C","M","b","b","dl","Y"]],Charcoal:[["C","m","m","B","D"]],Lava:[["C","m","m","b","b","D"]],Ash:[["C","m","m","B","d","d"],["C","m","m","B","d","dl"],["C","m","m","B","dl","dl"],["C","m","m","B","d","Y"],["C","m","m","B","dl","Y"]],Sand:[["C","m","m","b","b","d","d"],["C","m","m","b","b","d","dl"],["C","m","m","b","b","dl","dl"],["C","m","m","b","b","d","Y"],["C","m","m","b","b","dl","Y"]]},metabolism:{"Bog breath":[["bog","bog"],["bog","Y"]],"Normal metabolism":[["Bog","Bog"],["Bog","bog"],["Bog","Y"]]},liveliness:{Alive:[["D"],["d"]],Dead:[["dl","dl"],["dl","Y"]]}},getImageName:function(g){var c,f,d,e;d=function(h){return g.getCharacteristic(h)};if(d("liveliness")==="Dead"){return"dead-drake.png"}c="";e=d("color");if(e==="Silver"){e="Argent"}else{if(e==="Lava"){e="Earth"}else{if(e==="Ash"){e="Dust"}}}c+=e.toLowerCase().substring(0,2)+"_";c+=g.sex===BioLogica.FEMALE?"f_":"m_";c+=d("wings")==="Wings"?"wing_":"noWing_";f="";if(d("forelimbs")==="Forelimbs"){if(d("hindlimbs")==="Hindlimbs"){f="allLimb_"}else{f="fore_"}}else{if(d("hindlimbs")==="Hindlimbs"){f="hind_"}else{f="noLimb_"}}c+=f;c+=(function(){switch(d("armor")){case"Five armor":return"a5_";case"Three armor":return"a3_";case"One armor":return"a1_";default:return"a0_"}})();c+=(function(){switch(d("tail")){case"Long tail":return"flair_";case"Kinked tail":return"kink_";default:return"short_"}})();c+=d("horns")==="Horns"?"horn_":"noHorn_";c+=d("nose spike")==="Nose spike"?"rostral_":"noRostral_";c+=d("metabolism")==="Bog breath"?"bogbreath":"healthy";return c+=".png"},makeAlive:function(f){var e,d,c;if(f.getCharacteristic("liveliness")==="Dead"){c=f.sex===BioLogica.MALE?"x":ExtMath.flip()?"x1":"x2";e=f.getGenotype().chromosomes.XY[c];d=ExtMath.flip()?"D":"d";f.getGenotype().replaceAllele(e,"dl",d);return f.resetPhenotype()}}}}).call(this);