(function(){var b,a={}.hasOwnProperty,c=[].indexOf||function(f){for(var e=0,d=this.length;e<d;e++){if(e in this&&this[e]===f){return e}}return -1};Array.prototype.remove=function(f,e){var d;d=this.slice((e||f)+1||this.length);this.length=f<0?this.length+f:f;return this.push.apply(this,d)};Array.prototype.removeObj=function(e){var d;d=this.indexOf(e);if(~d){this.remove(d);return true}else{return false}};Array.prototype.replaceFirst=function(e,d){return this[this.indexOf(e)]=d};Array.prototype.shuffle=function(){var f,d,e;e=this.length;if(e){while(--e){f=Math.floor(Math.random()*(e+1));d=this[f];this[f]=this[e];this[e]=d}}return this};window.ExtMath={};ExtMath.randomInt=function(d){return Math.floor(Math.random()*d)};ExtMath.flip=function(){return ExtMath.randomInt(2)};b=function(j){var g,m,l,d,e,n,i,h,k,f;n=[];l=j[0];if(j.length===1){return l.slice(0)}m=b(j.slice(1));for(i=0,k=m.length;i<k;i++){g=m[i];if(typeof g==="string"){g=[g]}for(h=0,f=l.length;h<f;h++){d=l[h];e=g.slice(0);e.unshift(d);n.push(e)}}return n.slice(0)};window.BioLogica={};BioLogica.FEMALE=1;BioLogica.MALE=0;BioLogica.Chromosome=(function(){function d(h,f,g,e){var i=this;this.species=h;this.chromosome=f;this.side=g;this.alleles=e.sort(function(k,j){if(i.getAllelesPosition(k)>i.getAllelesPosition(j)){return 1}else{return -1}})}d.prototype.clone=function(e){return new BioLogica.Chromosome(this.species,this.chromosome,e||this.side,this.alleles.slice(0))};d.prototype.lengthInCentimorgans=100;d.prototype.getlengthInBasePairs=function(){return this.species.chromosomesLength[this.chromosome]};d.prototype.getGeneOfAllele=function(e){var h,g,f;f=this.species.geneList;for(g in f){if(!a.call(f,g)){continue}h=f[g];if(~h.alleles.indexOf(e)){return g}}};d.prototype.getAllelesPosition=function(e){var g,f;g=this.getGeneOfAllele(e);return((f=this.species.geneList[g])!=null?f.start:void 0)||-1};return d})();BioLogica.Chromosome.createChromosome=function(m,l,h){var d,j,g,e,k,f;g=[];f=m.alleles;for(j=e=0,k=f.length;e<k;j=++e){d=f[j];if(m.getAllelesPosition(d)<h){g.push(d)}else{g.push(l.alleles[j])}}return new BioLogica.Chromosome(m.species,m.chromosome,m.side,g)};BioLogica.Genotype=(function(){function d(m,e,k){var i,f,l,g,j,h;this.sex=k;this.chromosomes={};this.allAlleles=[];for(f in e){if(!a.call(e,f)){continue}g=e[f];this.chromosomes[f]={};for(l in g){if(!a.call(g,l)){continue}i=g[l];if(l==="y"){i=[]}this.chromosomes[f][l]=new BioLogica.Chromosome(m,f,l,i.slice(0));this.allAlleles=this.allAlleles.concat(i.slice(0))}}if((j=this.sex)==null){this.sex=((h=this.chromosomes.XY)!=null?h.y:void 0)!=null?BioLogica.MALE:BioLogica.FEMALE}}d.prototype.containsAlleles=function(f){var i,g,h,e;i=this.allAlleles.slice(0);if(this.sex===BioLogica.MALE){i.push("Y")}for(h=0,e=f.length;h<e;h++){g=f[h];if(!i.removeObj(g)){return false}}return true};d.prototype.replaceAllele=function(e,f,g){e.alleles.replaceFirst(f,g);return this.allAlleles.replaceFirst(f,g)};d.prototype.getAlleleString=function(){var g,r,j,o,f,e,m,q,n,k,p,l,h;r="";l=this.chromosomes;for(o in l){if(!a.call(l,o)){continue}e=l[o];for(n in e){if(!a.call(e,n)){continue}f=e[n];j=f.alleles;q=n==="x"?"y":n==="x1"?"x2":"b";if(n==="x"||n==="x1"){n="a"}if(n!=="a"){continue}for(m=k=0,p=j.length;k<p;m=++k){g=j[m];r+=""+n+":"+g+",";if(e[q]){r+="b:"+((h=e[q])!=null?h.alleles[m]:void 0)+","}}}}return r.substring(0,r.length-1)};return d})();BioLogica.Genetics=(function(){function d(g,f,h){var e;this.species=g;this.alleles=f;e=typeof this.alleles==="string"?this.convertAlleleStringToGenotypeHash(this.alleles,h):this.alleles;this.topUpChromosomes(e);this.genotype=new BioLogica.Genotype(this.species,e,h)}d.prototype.convertAlleleStringToGenotypeHash=function(r,m){var h,j,p,e,n,g,o,k,i,q,f,l;o=BioLogica.Genetics.parseAlleleString(r);e={};l=this.species.chromosomeNames;for(k=0,q=l.length;k<q;k++){p=l[k];e[p]={};g=this.getSides(p,m);e[p][g[0]]=[];e[p][g[1]]=[]}for(n in o){if(!a.call(o,n)){continue}j=o[n];if(!j){continue}for(i=0,f=j.length;i<f;i++){h=j[i];p=this.findChromosome(h);if(!p){continue}g=this.getSides(p,m);e[p][n==="a"?g[0]:g[1]].push(h)}}return e};d.prototype.topUpChromosomes=function(e){var i,g,k,j,h,f;f=[];for(i in e){if(!a.call(e,i)){continue}g=e[i];j=this.species.chromosomeGeneMap[i];f.push((function(){var n,l,m;m=[];for(n=0,l=j.length;n<l;n++){k=j[n];m.push((function(){var o;o=[];for(h in g){if(!a.call(g,h)){continue}if(!(this.chromosomeContainsGene(e[i][h],k)||h==="y")){o.push(e[i][h].push(this.getRandomAllele(k)))}else{o.push(void 0)}}return o}).call(this))}return m}).call(this))}return f};d.prototype.getSides=function(e,f){if(e!=="XY"){return["a","b"]}else{if(f===BioLogica.FEMALE){return["x1","x2"]}else{return["x","y"]}}};d.prototype.isAlleleOfGene=function(e,h){var f,i,g;g=this.species.geneList;for(i in g){if(!a.call(g,i)){continue}f=this.species.geneList[i].alleles;if(c.call(f,e)>=0&&c.call(f,h)>=0){return true}}return false};d.prototype.findChromosome=function(h){var f,k,g,j,e,i;i=this.species.chromosomeGeneMap;for(f in i){g=i[f];for(j=0,e=g.length;j<e;j++){k=g[j];if(this.isAlleleOfGene(h,k)){return f}}}return false};d.prototype.chromosomeContainsGene=function(f,i){var g,h,e;for(h=0,e=f.length;h<e;h++){g=f[h];if(this.isAlleleOfGene(g,i)){return true}}return false};d.prototype.getRandomAllele=function(i){var g,j,f,e,h;h=this.species.geneList;for(j in h){if(!a.call(h,j)){continue}e=this.species.geneList[j].alleles;if(c.call(e,i)>=0){g=e;break}}f=Math.floor(Math.random()*g.length);return g[f]};d.prototype.filter=function(e,f){var g=this;return e.filter(function(i){var k,j,h;for(j=0,h=f.length;j<h;j++){k=f[j];if(g.isAlleleOfGene(i,k)){return true}}return false})};d.prototype.performMeiosis=function(s){var q,t,n,f,e,r,l,g,m,o,h,j,p,k;t=[{},{},{},{}];k=this.genotype.chromosomes;for(n in k){if(!a.call(k,n)){continue}e=k[n];h={};o=["b2","b1","a2","a1"];r=false;for(m in e){if(!a.call(e,m)){continue}f=e[m];g=this.getHaploidChromatidSide(f);h[o.pop()]=f.clone(g);h[o.pop()]=f.clone(g);if(m==="y"){r=true}}if(s&&!r){this.crossover(h)}o=["b2","b1","a2","a1"].shuffle();for(l=j=0,p=t.length;j<p;l=++j){q=t[l];q[n]=h[o[l]]}}return t};d.prototype.getHaploidChromatidSide=function(e){if(e.side==="b"){return"a"}else{if(e.side==="x1"||e.side==="x2"){return"x"}else{return e.side}}};d.prototype.crossover=function(e){var i,l,m,k,h,g,j,f;i=this.createCrossoverPoints(e.a1);f=[];for(g=0,j=i.length;g<j;g++){k=i[g];h=["a1","a2"][ExtMath.flip()];l=["b1","b2"][ExtMath.flip()];m=this.crossChromatids(e[h],e[l],k);e[h]=m[0];f.push(e[l]=m[1])}return f};d.prototype.crossChromatids=function(g,f,e){return[BioLogica.Chromosome.createChromosome(f,g,e),BioLogica.Chromosome.createChromosome(g,f,e)]};d.prototype.createCrossoverPoints=function(k){var h,l,j,e,n,f,g,m;f=Math.floor(k.lengthInCentimorgans/10);l=(function(){var o,i;i=[];for(j=o=0;0<=f?o<f:o>f;j=0<=f?++o:--o){if(Math.random()<0.2){i.push(j)}}return i})();while(l.length>3){l.remove(ExtMath.randomInt(l.length))}e=k.getlengthInBasePairs()/f;for(j=g=0,m=l.length;g<m;j=++g){h=l[j];n=ExtMath.randomInt(e);l[j]=(h*e)+n}return l};return d})();BioLogica.Genetics.parseAlleleString=function(e){var f,d;return{a:(f=e.match(/a:([^,])*/g))!=null?f.map(function(h){var g;return(g=h.match(/[^:]+$/))!=null?g[0]:void 0}):void 0,b:(d=e.match(/b:([^,])*/g))!=null?d.map(function(g){var h;return(h=g.match(/[^:]+$/))!=null?h[0]:void 0}):void 0}};BioLogica.Phenotype=(function(){function d(g){var i,f,h,e,l,j,m,k;this.characteristics={};k=g.species.traitRules;for(l in k){if(!a.call(k,l)){continue}e=k[l];for(h in e){if(!a.call(e,h)){continue}f=e[h];for(j=0,m=f.length;j<m;j++){i=f[j];if(g.genotype.containsAlleles(i)){this.characteristics[l]=h;break}}if(this.characteristics[l]){break}}}}return d})();BioLogica.Organism=(function(){function d(f,e,g){var h;this.species=f;this.sex=g;this.alleles=typeof e==="string"?this.preProcessAlleleString(e):e;this.genetics=new BioLogica.Genetics(this.species,this.alleles,this.sex);if((h=this.sex)==null){this.sex=this.genetics.genotype.sex}this.resetPhenotype()}d.prototype.getGenotype=function(){return this.genetics.genotype};d.prototype.resetPhenotype=function(){return this.phenotype=new BioLogica.Phenotype(this.genetics)};d.prototype.getCharacteristic=function(e){return this.phenotype.characteristics[e]};d.prototype.getImageName=function(){return this.species.getImageName(this)};d.prototype.createGametes=function(k,f){var e,g,j,h;if(f==null){f=true}e=[];for(g=j=0,h=Math.floor(k/4);0<=h?j<h:j>h;g=0<=h?++j:--j){e=e.concat(this.genetics.performMeiosis(f))}e=e.concat(this.genetics.performMeiosis(f).slice(0,k%4));if(e.length===1){return e[0]}else{return e}};d.prototype.preProcessAlleleString=function(e){return e.replace(/,+$/,"")};d.prototype.toString=function(){var e,f;f=this.sex===BioLogica.FEMALE?"female":"male";e=this.genetics.genotype.allAlleles;return"Organism: {sex: "+f+", authored alleles: "+this.alleles+", alleles: "+e};return d})();BioLogica.Organism.createOrganism=function(e,d,f){if(d==null){d=""}if(f==null){f=ExtMath.flip()?BioLogica.FEMALE:BioLogica.MALE}return new BioLogica.Organism(e,d,f)};BioLogica.Organism.createLiveOrganism=function(e,d,f){var g;if(d==null){d=""}if(f==null){f=ExtMath.flip()?BioLogica.FEMALE:BioLogica.MALE}g=new BioLogica.Organism(e,d,f);g.species.makeAlive(g);return g};BioLogica.Organism.createFromGametes=function(m,l,f){var j,g,k,e,d,h;for(h in f){e=f[h];if(e.side==="a"){e.side="b"}}if(f.XY.side==="x"){l.XY.side="x1";f.XY.side="x2"}d={};for(k in l){if(!a.call(l,k)){continue}j=l[k];g=f[k];d[k]={};d[k][j.side]=j.alleles;d[k][g.side]=g.alleles}return new BioLogica.Organism(m,d)};BioLogica.breed=function(g,f,h){var e,d;e=g.createGametes(1,h);d=f.createGametes(1,h);return BioLogica.Organism.createFromGametes(g.species,e,d)};BioLogica.Species={};BioLogica.Species.Drake={name:"Drake",chromosomeNames:["1","2","XY"],chromosomeGeneMap:{"1":["t","m","w","h"],"2":["c","b","fl","hl","a"],XY:["d","rh","bog"]},chromosomesLength:{"1":100000000,"2":100000000,XY:70000000},geneList:{tail:{alleles:["T","Tk","t"],start:10000000,length:10584},metalic:{alleles:["M","m"],start:20000000,length:259610},wings:{alleles:["W","w"],start:70000000,length:9094},horns:{alleles:["H","h"],start:85000000,length:19421},color:{alleles:["C","c"],start:15000000,length:64572},black:{alleles:["B","b"],start:25000000,length:17596},forelimbs:{alleles:["Fl","fl"],start:80000000,length:122234},hindlimbs:{alleles:["Hl","hl"],start:85000000,length:6371},armor:{alleles:["A1","A2","a"],start:90000000,length:425156},dilute:{alleles:["D","d","dl"],start:20000000,length:152673},bogbreath:{alleles:["Bog","bog"],start:22000000,length:199642},nose:{alleles:["Rh","rh"],start:60000000,length:2950}},alleleLabelMap:{T:"Long tail",Tk:"Kinked tail",t:"Short tail",M:"Metallic",m:"Nonmetallic",W:"Wings",w:"No wings",H:"No horns",h:"Horns",C:"Colored",c:"Colorless",Fl:"Forelimbs",fl:"No forelimbs",Hl:"Hindlimbs",hl:"No hindlimbs",A1:"'A1' armor",A2:"'A2' armor",a:"'a' armor",B:"Black",b:"Brown",D:"Full color",d:"Dilute color",dl:"dl",Rh:"Nose spike",rh:"No nose spike",Bog:"Normal metabolism",bog:"Bog breath",Y:"Y","":""},traitRules:{armor:{"Five armor":[["A1","A1"],["A1","A2"]],"Three armor":[["A1","a"],["A2","A2"]],"One armor":[["A2","a"]],"No armor":[["a","a"]]},tail:{"Long tail":[["T","T"],["T","Tk"],["T","t"]],"Kinked tail":[["Tk","Tk"],["Tk","t"]],"Short tail":[["t","t"]]},forelimbs:{Forelimbs:[["Fl","Fl"],["Fl","fl"]],"No forelimbs":[["fl","fl"]]},hindlimbs:{Hindlimbs:[["Hl","Hl"],["Hl","hl"]],"No hindlimbs":[["hl","hl"]]},horns:{Hornless:[["H","H"],["H","h"]],Horns:[["h","h"]]},"nose spike":{"Nose spike":b([["Rh"],["Rh","rh","Y"]]),"No nose spike":[["rh","rh"],["rh","Y"]]},wings:{Wings:[["W","W"],["W","w"]],"No wings":[["w","w"]]},color:{Frost:[["c","c"]],Steel:b([["C"],["C","c"],["M"],["M","m"],["B"],["B","b"],["D"],["D","d","dl","Y"]]),Copper:b([["C"],["C","c"],["M"],["M","m"],["b"],["b"],["D"],["D","d","dl","Y"]]),Silver:b([["C"],["C","c"],["M"],["M","m"],["B"],["B","b"],["d","dl"],["d","dl","Y"]]),Gold:b([["C"],["C","c"],["M"],["M","m"],["b"],["b"],["d","dl"],["d","dl","Y"]]),Charcoal:b([["C"],["C","c"],["m"],["m"],["B"],["B","b"],["D"],["D","d","dl","Y"]]),Lava:b([["C"],["C","c"],["m"],["m"],["b"],["b"],["D"],["D","d","dl","Y"]]),Ash:b([["C"],["C","c"],["m"],["m"],["B"],["B","b"],["d","dl"],["d","dl","Y"]]),Sand:b([["C"],["C","c"],["m"],["m"],["b"],["b"],["d","dl"],["d","dl","Y"]])},metabolism:{"Bog breath":[["bog","bog"],["bog","Y"]],"Normal metabolism":[["Bog","Bog"],["Bog","bog"],["Bog","Y"]]},liveliness:{Alive:b([["D","d"],["D","d","dl","Y"]]),Dead:[["dl","dl"],["dl","Y"]]}},getImageName:function(h){var d,g,e,f;e=function(i){return h.getCharacteristic(i)};if(e("liveliness")==="Dead"){return"dead-drake.png"}d="";f=e("color");if(f==="Silver"){f="Argent"}else{if(f==="Lava"){f="Earth"}else{if(f==="Ash"){f="Dust"}}}d+=f.toLowerCase().substring(0,2)+"_";d+=h.sex===BioLogica.FEMALE?"f_":"m_";d+=e("wings")==="Wings"?"wing_":"noWing_";g="";if(e("forelimbs")==="Forelimbs"){if(e("hindlimbs")==="Hindlimbs"){g="allLimb_"}else{g="fore_"}}else{if(e("hindlimbs")==="Hindlimbs"){g="hind_"}else{g="noLimb_"}}d+=g;d+=(function(){switch(e("armor")){case"Five armor":return"a5_";case"Three armor":return"a3_";case"One armor":return"a1_";default:return"a0_"}})();d+=(function(){switch(e("tail")){case"Long tail":return"flair_";case"Kinked tail":return"kink_";default:return"short_"}})();d+=e("horns")==="Horns"?"horn_":"noHorn_";d+=e("nose spike")==="Nose spike"?"rostral_":"noRostral_";d+=e("metabolism")==="Bog breath"?"bogbreath":"healthy";return d+=".png"},makeAlive:function(g){var f,e,d;if(g.getCharacteristic("liveliness")==="Dead"){d=g.sex===BioLogica.MALE?"x":ExtMath.flip()?"x1":"x2";f=g.getGenotype().chromosomes.XY[d];e=ExtMath.flip()?"D":"d";g.getGenotype().replaceAllele(f,"dl",e);return g.resetPhenotype()}}}}).call(this);